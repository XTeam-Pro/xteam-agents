"""
Chief Scientist - Главный ученый

Координирует все научные исследования, определяет стратегию,
обеспечивает научную строгость и интеграцию результатов.
"""

from typing import Dict, Any, List
from xteam_agents.agents.research_team.research_base import ResearchAgent, ResearchCritic
from xteam_agents.agents.research_team.research_state import ResearchState, ResearchPhase
from xteam_agents.llm.provider import LLMProvider
from xteam_agents.memory.manager import MemoryManager


class ChiefScientist(ResearchAgent):
    """
    Главный ученый - координатор научной работы.

    РОЛЬ:
    - Стратегическое руководство научными исследованиями
    - Обеспечение научной строгости и методологической корректности
    - Координация работы всех ученых
    - Формулировка исследовательских вопросов
    - Интеграция результатов различных исследований
    - Валидация научных выводов

    КОМПЕТЕНЦИИ:
    1. Фундаментальная наука
       - Формулировка научных гипотез
       - Дизайн экспериментов
       - Статистический анализ
       - Peer review и валидация

    2. Управление исследованиями
       - Планирование исследовательских программ
       - Распределение задач между учеными
       - Контроль качества исследований
       - Управление рисками

    3. Междисциплинарная интеграция
       - Связывание результатов из разных областей
       - Выявление синергий
       - Построение целостной картины

    4. Стратегическое мышление
       - Определение приоритетов исследований
       - Оценка потенциального влияния
       - Долгосрочное планирование

    МЕТОДЫ РАБОТЫ:
    1. Анализ исследовательского запроса
       - Декомпозиция сложных вопросов
       - Выявление ключевых проблем
       - Определение границ исследования

    2. Формирование научной стратегии
       - Выбор методологии
       - Определение критериев успеха
       - Планирование валидации

    3. Координация команды
       - Назначение ответственных
       - Определение зависимостей
       - Синхронизация работы

    4. Контроль качества
       - Проверка научной обоснованности
       - Валидация статистических выводов
       - Обеспечение воспроизводимости

    ОБЛАСТИ ЭКСПЕРТИЗЫ:
    - Методология научных исследований
    - Экспериментальный дизайн
    - Статистический анализ и инференция
    - Machine Learning и AI research
    - Педагогическая наука
    - Когнитивная психология
    - Learning Analytics
    - Образовательные технологии
    - Дизайн датасетов
    - Разработка нейронных архитектур

    РЕЗУЛЬТАТЫ РАБОТЫ:
    1. Research Strategy Document
       - Цели и задачи исследования
       - Методология
       - План работ
       - Критерии успеха

    2. Scientific Coordination Plan
       - Распределение задач
       - Зависимости между задачами
       - График исследований

    3. Quality Assurance Framework
       - Критерии качества
       - Процедуры валидации
       - Метрики успеха

    4. Integrated Research Report
       - Обобщение всех результатов
       - Научные выводы
       - Рекомендации для разработки
    """

    def __init__(self, llm_provider: LLMProvider, memory_manager: MemoryManager):
        super().__init__(
            llm_provider=llm_provider,
            memory_manager=memory_manager,
            agent_name="Chief Scientist",
            role="Главный ученый и координатор научных исследований",
            expertise=[
                "Методология научных исследований",
                "Экспериментальный дизайн",
                "Статистический анализ",
                "Machine Learning research",
                "Педагогическая наука",
                "Когнитивная психология",
                "Learning Analytics",
                "Образовательные технологии",
                "Дизайн исследований",
                "Научное руководство",
            ],
            research_methods=[
                "Формулировка исследовательских вопросов",
                "Дизайн экспериментов",
                "Квантитативный анализ",
                "Квалитативные методы",
                "Смешанные методы",
                "Мета-анализ",
                "Систематический обзор",
                "Валидация результатов",
                "Peer review",
                "Научная координация",
            ],
        )

    async def conduct_research(self, state: ResearchState) -> Dict[str, Any]:
        """
        Проведение исследования в роли главного ученого.

        АЛГОРИТМ РАБОТЫ:

        1. ИНИЦИАЛИЗАЦИЯ (ResearchPhase.INITIALIZATION)
           - Анализ исследовательского запроса
           - Формулировка главного исследовательского вопроса
           - Определение целей и задач
           - Оценка сложности и ресурсов

        2. СТРАТЕГИЧЕСКОЕ ПЛАНИРОВАНИЕ
           - Выбор методологии исследования
           - Декомпозиция на подзадачи
           - Назначение ответственных ученых
           - Определение последовательности работ

        3. КООРДИНАЦИЯ ВЫПОЛНЕНИЯ
           - Мониторинг прогресса
           - Решение методологических вопросов
           - Интеграция промежуточных результатов

        4. ВАЛИДАЦИЯ И ИНТЕГРАЦИЯ
           - Проверка научной обоснованности
           - Интеграция результатов от всех ученых
           - Формулировка общих выводов

        5. ФИНАЛИЗАЦИЯ
           - Подготовка итогового отчета
           - Формирование рекомендаций для разработки
           - Определение дальнейших исследований

        Args:
            state: Текущее состояние исследования

        Returns:
            Обновления состояния с результатами работы главного ученого
        """
        updates: Dict[str, Any] = {
            "messages": [],
            "assigned_agents": {},
        }

        # Запрос контекста из базы знаний
        context = await self.query_knowledge_base(
            query=state.research_question,
            context={"task_type": state.task_type.value}
        )

        # Генерация стратегии исследования
        system_prompt = self.get_system_prompt()

        user_prompt = f"""
ИССЛЕДОВАТЕЛЬСКАЯ ЗАДАЧА:
Тип: {state.task_type.value}
Сложность: {state.complexity.value}
Вопрос: {state.research_question}

ЦЕЛИ:
{chr(10).join(f"- {obj}" for obj in state.objectives) if state.objectives else "Не определены"}

ОБЛАСТЬ ИССЛЕДОВАНИЯ:
{state.scope if state.scope else "Требует определения"}

ОГРАНИЧЕНИЯ:
{chr(10).join(f"- {c}" for c in state.constraints) if state.constraints else "Отсутствуют"}

КОНТЕКСТ ИЗ БАЗЫ ЗНАНИЙ:
{chr(10).join(f"- {item.get('text', '')[:200]}..." for item in context[:3])}

ТЕКУЩАЯ ФАЗА: {state.current_phase.value}

ВАША ЗАДАЧА как Главного ученого:

1. АНАЛИЗ И СТРАТЕГИЯ:
   - Сформулируйте точный исследовательский вопрос
   - Определите конкретные цели исследования (3-5 целей)
   - Выберите оптимальную методологию
   - Обоснуйте выбор методологии

2. ДЕКОМПОЗИЦИЯ:
   - Разбейте исследование на логические этапы
   - Определите, какие ученые нужны для каждого этапа:
     * Data Scientist - анализ данных, статистика, датасеты
     * ML Researcher - разработка моделей, архитектуры, обучение
     * Cognitive Scientist - когнитивные аспекты, процессы обучения
     * Pedagogical Researcher - педагогические методы, эффективность
   - Установите зависимости между этапами

3. КРИТЕРИИ КАЧЕСТВА:
   - Определите метрики успеха
   - Установите процедуры валидации
   - Укажите критерии приемлемости результатов

4. РИСКИ И ОГРАНИЧЕНИЯ:
   - Выявите потенциальные риски
   - Определите ограничения исследования
   - Предложите стратегии митигации

ФОРМАТ ОТВЕТА (JSON):
{{
  "refined_research_question": "Уточненный исследовательский вопрос",
  "objectives": ["Цель 1", "Цель 2", ...],
  "methodology": "Описание методологии исследования",
  "methodology_rationale": "Обоснование выбора методологии",
  "research_phases": [
    {{
      "phase": "название_фазы",
      "description": "описание",
      "assigned_agent": "имя_агента",
      "deliverables": ["результат 1", "результат 2"],
      "duration_estimate": "оценка времени"
    }}
  ],
  "success_metrics": ["Метрика 1", "Метрика 2", ...],
  "validation_procedures": ["Процедура 1", "Процедура 2", ...],
  "risks": ["Риск 1", "Риск 2", ...],
  "mitigation_strategies": ["Стратегия 1", "Стратегия 2", ...],
  "expected_outcomes": ["Ожидаемый результат 1", ...],
  "next_steps": ["Следующий шаг 1", ...]
}}
"""

        response = await self.generate_with_llm(
            system_prompt=system_prompt,
            user_prompt=user_prompt,
            temperature=0.6,
            max_tokens=4000,
        )

        # TODO: Парсинг JSON из ответа и обновление состояния
        # В реальной реализации здесь должен быть парсинг structured output

        # Создание артефакта с исследовательской стратегией
        strategy_artifact = await self.create_artifact(
            state=state,
            artifact_type="research_strategy",
            title="Research Strategy and Coordination Plan",
            description="Стратегический план научного исследования",
            content={
                "strategy": response,
                "context_used": context[:3],
            },
            metadata={
                "phase": state.current_phase.value,
                "complexity": state.complexity.value,
            },
        )

        updates["artifacts"] = [strategy_artifact]
        updates["messages"].append({
            "agent": self.agent_name,
            "phase": state.current_phase.value,
            "message": f"Разработана стратегия исследования",
            "content": response[:500] + "..." if len(response) > 500 else response,
        })

        # Обновление фазы исследования
        if state.current_phase == ResearchPhase.INITIALIZATION:
            updates["current_phase"] = ResearchPhase.LITERATURE_REVIEW
            updates["phases_completed"] = [ResearchPhase.INITIALIZATION]

        return updates


class ChiefScientistCritic(ResearchCritic):
    """
    Критик главного ученого - внешний рецензент.

    РОЛЬ:
    - Независимая экспертная оценка исследовательской стратегии
    - Проверка методологической корректности
    - Выявление пробелов в планировании
    - Оценка реалистичности целей

    ФОКУСЫ ПРОВЕРКИ:
    1. Методологическая корректность
       - Соответствие методологии исследовательскому вопросу
       - Полнота методологии
       - Статистическая мощность

    2. Научная строгость
       - Четкость гипотез
       - Операционализация переменных
       - Контроль смешивающих факторов

    3. Практическая реализуемость
       - Реалистичность целей
       - Доступность ресурсов
       - Временные рамки

    4. Полнота планирования
       - Учет всех фаз исследования
       - Процедуры валидации
       - План обработки рисков
    """

    def __init__(self, llm_provider: LLMProvider, memory_manager: MemoryManager):
        super().__init__(
            llm_provider=llm_provider,
            memory_manager=memory_manager,
            critic_name="Chief Scientist Critic",
            review_focus=[
                "Методологическая корректность",
                "Научная строгость",
                "Практическая реализуемость",
                "Полнота исследовательского плана",
                "Качество декомпозиции задач",
                "Адекватность распределения ролей",
            ],
            quality_criteria=[
                "Четкость исследовательского вопроса",
                "Соответствие методологии целям",
                "Наличие процедур валидации",
                "Реалистичность временных рамок",
                "Полнота критериев успеха",
                "Учет рисков и ограничений",
            ],
        )

    async def review_research(
        self,
        state: ResearchState,
        artifact_to_review=None,
    ) -> Dict[str, Any]:
        """
        Рецензирование стратегии исследования от главного ученого.

        ПРОЦЕСС РЕЦЕНЗИИ:

        1. АНАЛИЗ ИССЛЕДОВАТЕЛЬСКОГО ВОПРОСА
           - Четкость формулировки
           - Научная обоснованность
           - Операционализируемость

        2. ОЦЕНКА МЕТОДОЛОГИИ
           - Соответствие целям
           - Адекватность методов
           - Научная валидность

        3. ПРОВЕРКА ПЛАНИРОВАНИЯ
           - Полнота фаз
           - Логичность последовательности
           - Распределение ответственности

        4. ОЦЕНКА РИСКОВ
           - Идентификация дополнительных рисков
           - Адекватность митигации
           - План управления рисками

        Returns:
            Результаты рецензии с оценкой и рекомендациями
        """
        # Получение последнего артефакта от главного ученого
        chief_artifacts = [
            a for a in state.artifacts
            if a.created_by == "Chief Scientist"
        ]

        if not chief_artifacts:
            return {
                "review_text": "Нет артефактов для рецензирования",
                "reviewer": self.critic_name,
                "verdict": "NEEDS_WORK",
            }

        latest_artifact = chief_artifacts[-1]

        review = await self.generate_review(
            content=str(latest_artifact.content),
            focus_areas=[
                "Методологическая корректность стратегии",
                "Четкость целей и задач",
                "Адекватность декомпозиции",
                "Реалистичность планирования",
                "Полнота критериев качества",
            ],
        )

        quality_score = self.get_quality_score(review)

        return {
            **review,
            "quality_score": quality_score,
            "artifact_reviewed": latest_artifact.title,
        }
